#zen-sidebar-top-buttons-customization-target {
  margin-left: calc(var(--collapsed-tab-bar-width)/2 - 18px) !important;

  #back-button {
    order: -3 !important;
  }

  #forward-button {
    order: -2 !important;
  }

  #stop-reload-button {
    order: -1 !important;
  }

  #zen-sidebar-top-buttons-separator {
    order: 0 !important;
  }

  #unified-extensions-button {
    order: 99 !important;
  }

  #PanelUI-button {
    order: 100 !important;
  }
}

:root:not([zen-compact-mode="true"]):not([chromehidden~="toolbar"]) {
  --transition-duration: var(--mod-autoexpand-animation_duration);
  --transition-delay: var(--mod-autoexpand-animation_delay);
  --transition-delay-after: var(--mod-autoexpand-collapse_delay);
  --expanded-tab-bar-width: var(--mod-autoexpand-expanded_width);
  --collapsed-tab-bar-width: var(--mod-autoexpand-collapsed_width);

  /*Elements with "Instant" transitions. These are delayed dynamically depending on if it's hover/unhover, and are never animated to improve performance.*/
  #zen-media-controls-toolbar,
  #zen-appcontent-wrapper,
  vbox.zen-workspace-tabs-section.zen-workspace-pinned-tabs-section,
  #nav-bar,
  tab:not([zen-essential]):not([pinned])[selected="true"] .tab-background,
  .tab-audio-button,
  #zen-media-controls-hbox>*:not(#zen-media-focus-button),
  #zen-media-main-vbox>*:not(#zen-media-controls-hbox),
  tab:not([zen-essential]) .tab-background,
  #tabs-newtab-button,
  .pinned-tabs-container-separator,
  .zen-current-workspace-indicator-name,
  .tab-group-label,
  #zen-sidebar-top-buttons-customization-target>* {
    transition: clip-path 0ms ease-in-out var(--transition-delay-fast),
      transform 0ms ease-in-out var(--transition-delay-fast),
      opacity 0ms ease-in-out var(--transition-delay-fast),
      width 0ms ease-in-out var(--transition-delay-fast),
      max-height 0ms ease var(--transition-delay-fast),
      z-index 0ms ease var(--transition-delay-fast) !important;
  }

  /*Elements with smooth transitions that are animated*/
  #navigator-toolbox,
  #tabbrowser-tabbox,
  #urlbar:not([open]),
  #urlbar-container,
  tab:is([zen-essential]),
  #zen-workspaces-button,
  #zen-workspaces-button .subviewbutton,
  #tabs-newtab-button .toolbarbutton-text,
  #zen-media-focus-button::after,
  tab:not([zen-essential]),
  .tab-label-container,
  #zen-sidebar-foot-buttons>*:not(#zen-workspaces-button) {
    transition: clip-path var(--transition-duration) ease-in-out var(--transition-delay-smooth),
      transform var(--transition-duration) ease-in-out var(--transition-delay-smooth),
      opacity var(--transition-duration) ease-in-out var(--transition-delay-smooth),
      width var(--transition-duration) ease-in-out var(--transition-delay-smooth),
      max-height var(--transition-duration) ease var(--transition-delay-smooth) !important;
  }

  /*Main code block that defines the expanded state (reverts changes of the collapsed state, and clips the viewport)*/
  #navigator-toolbox {
    --transition-delay-smooth: var(--transition-delay-after);
    --transition-delay-fast: calc(var(--transition-duration) + var(--transition-delay-after));

    ~#zen-appcontent-wrapper {
      --transition-delay-smooth: var(--transition-delay-after);
      --transition-delay-fast: calc(var(--transition-duration) + var(--transition-delay-after));
    }

    --my-width: calc(var(--collapsed-tab-bar-width) + 8px);
    --hide: calc(var(--expanded-tab-bar-width) - var(--collapsed-tab-bar-width) - 5px);

    clip-path: inset(0 var(--hide) 0 0);
    position: absolute !important;
    height: 100%;
    min-width: 100px !important;
    width: var(--expanded-tab-bar-width) !important;
    --hover-width: 100px;

    /*Expanded state. Activates on hover, popup menu, etc*/
    &:is(:hover, [has-popup-menu=""], [movingtab], [flash-popup]),
    &:has(toolbarbutton[open="true"]:not(#zen-sidepanel-button), #urlbar[open]) {
      --transition-delay-smooth: calc(var(--transition-delay) + 0ms);
      --transition-delay-fast: var(--transition-delay);

      ~#zen-appcontent-wrapper {
        --transition-delay-smooth: calc(var(--transition-delay) + 0ms);
        --transition-delay-fast: var(--transition-delay);
      }

      clip-path: inset(0 0 0 0);
      --my-width: var(--expanded-tab-bar-width);

      ~#zen-appcontent-wrapper {
        z-index: 0 !important;
      }

      ~#zen-appcontent-wrapper #tabbrowser-tabbox {
        clip-path: inset(-2px -2px -2px calc(var(--expanded-tab-bar-width) - var(--collapsed-tab-bar-width)) round 10px);
      }

      tab:not([zen-essential]) .tab-background {
        width: 100% !important;
      }

      #nav-bar {
        width: 100% !important;
      }

      .tab-label-container {
        opacity: 100% !important;
      }

      #zen-sidebar-foot-buttons {
        opacity: 100% !important;
      }

      tab:is([zen-essential], [pinned]) {
        width: 100% !important;
      }

      .toolbarbutton-text {
        opacity: 100% !important;
      }

      #urlbar:not([open]),
      #urlbar-container {
        clip-path: inset(0 0 0 0 round 10px) !important;
      }

      tab:not([zen-essential]) {
        width: 100%;
      }

      .pinned-tabs-container-separator {
        width: inherit !important;
        margin-inline: inherit !important;
        display: block !important;
        justify-self: inherit !important;
      }

      tab-group .tabbrowser-tab {
        transform: translateX(0px);
        --tab-width: calc(100% - 15px);
        width: var(--tab-width) !important;
      }

      .tab-group-label {
        opacity: 100%;
      }
    }
  }

  /*Important: Makes so that the webpage display covers the tab bar*/
  #zen-appcontent-wrapper {
    z-index: 1000 !important;
  }

  /*Adds dynamic drop shadow to this element that parents tabbrowser-tabbox so the shadow follows the web page with the clip path*/
  #zen-tabbox-wrapper {
    filter: drop-shadow(0px 0px 6px rgba(0, 0, 0, 0.5));
  }

  /*initial clip path state*/
  #tabbrowser-tabbox {
    clip-path: inset(-2px -2px -2px -2px round 5px);
  }

  /*Adds space for the tab icons*/
  #navigator-toolbox~#zen-appcontent-wrapper {
    margin-left: var(--collapsed-tab-bar-width);
  }

  /* CENTER FAVICONS on collapsed state */
  tab:not([zen-essential]) {
    .tab-icon-image {
      margin-left: 4px !important;
      margin-right: 4px !important;
    }

    .tab-background {
      width: 36px !important;
    }
  }

  #navigator-toolbox:not([zen-right-side="true"]) {

    .zen-workspace-normal-tabs-section,
    .zen-workspace-pinned-tabs-section {
      padding-left: calc((var(--collapsed-tab-bar-width) - 36px)/2) !important;
    }

    tab:not([zen-essential]) .tab-icon-image {
      margin-right: 9px !important;
    }
  }

  /*hide splitter*/
  #zen-sidebar-splitter {
    visibility: hidden !important;
  }

  /*Puts the url bar in the right place for the single toolbar mode, since we changed navigator-toolbox to position: absolute*/
  @media (-moz-bool-pref: "zen.view.use-single-toolbar") {
    #nav-bar {
      position: relative !important;
    }
  }

  /*adds relief for window buttons on a right-sided tab bar, and for the back button on the left tab bar*/
  @media not all and (-moz-bool-pref: "zen.view.use-single-toolbar") {
    #zen-main-app-wrapper[zen-compact-mode="false"] {
      #navigator-toolbox[zen-right-side="true"]~#zen-appcontent-wrapper #nav-bar {
        padding-right: 100px !important;
      }

      #navigator-toolbox:not([zen-right-side="true"])~#zen-appcontent-wrapper #nav-bar {
        padding-left: 25px !important;
      }
    }
  }

  /*collapses url bar when not hovered*/
  #navigator-toolbox #urlbar:not([open]),
  #urlbar-container {
    clip-path: inset(0 calc(var(--expanded-tab-bar-width) - var(--collapsed-tab-bar-width) + 1px) 0 0 round 10px) !important;
  }

  /*collapses essentials when not hovered*/
  tab:is([zen-essential]) {
    width: calc(var(--collapsed-tab-bar-width) - 5px) !important;
  }

  /*aligns pinned tab favicons*/
  #navigator-toolbox vbox.zen-workspace-tabs-section.zen-workspace-pinned-tabs-section {
    margin: 0 !important;
  }

  /*fades tab text*/
  .tab-label-container {
    opacity: 0% !important;
  }

  #zen-sidebar-foot-buttons>toolbaritem:not(:first-of-type) {
    opacity: 0% !important;
  }

  /*Collapses tab for square backgrounds on hover, during collapsed state*/
  tab:not([zen-essential]) {
    width: 37px;
  }

  /*collapses the thin line separator*/
  .pinned-tabs-container-separator {
    width: calc(var(--collapsed-tab-bar-width) - 6px) !important;
    margin-inline: 0px !important;
    display: flex !important;
    justify-self: start !important;
  }

  #navigator-toolbox:not(:is( :hover,
      [has-popup-menu=""],
      [movingtab],
      [flash-popup],
      :has(toolbarbutton[open="true"]:not(#zen-sidepanel-button), #urlbar[open]))) {
    #zen-sidebar-top-buttons-customization-target>*:not(#back-button) {
      opacity: 0 !important;
    }
  }

  /*Made the arrowscrollbox collapse in the right direction, now it fixes tab sizing*/
  #navigator-toolbox {
    .workspace-arrowscrollbox {
      width: calc(var(--expanded-tab-bar-width) + 0px) !important;
    }

    .workspace-arrowscrollbox {
      margin-right: auto !important;
    }
  }

  /*Fixes pinned tab reset button*/
  #navigator-toolbox {
    .tabbrowser-tab[zen-pinned-changed] {
      .tab-icon-stack {
        position: relative !important;
        transform: translate(-11px, -20px) !important;
      }

      .tab-reset-pin-button {
        position: absolute !important;
        width: 30px !important;

        &::after {
          margin-left: 3px !important;
        }
      }

      .tab-label-container {
        margin-left: 2px !important;
      }
    }
  }

  /*Reworks the tab close button on the left side, preventing accidental clicks during the collapsed state*/
  #navigator-toolbox {
    &:hover .tabbrowser-tab .tab-close-button {
      clip-path: inset(0 0 0 0);
      transition: clip-path 0ms ease-in-out calc(var(--transition-delay) + var(--transition-duration)) !important;
    }

    tab:not([zen-essential]) {
      .tab-close-button {
        display: flex !important;
        position: absolute !important;
        opacity: 0% !important;
        clip-path: inset(100% 0 0 0);
        transition: clip-path 0ms ease-in-out var(--transition-delay-after) !important;
      }

      &:hover .tab-close-button {
        position: relative !important;
        opacity: 100% !important;
      }

      &[selected="true"] .tab-close-button {
        position: relative !important;
        opacity: 100% !important;
      }

      &[pinned]:not([pending="true"]) .tab-close-button {
        display: none !important;
      }
    }
  }
}